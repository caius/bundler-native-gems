#!/usr/bin/env ruby

require "bundler/cli"
require "terminal-table"

class NativeGems
  def initialize(_options)
  end

  def run
    groups = definition.groups
    resolved_specs = definition.specs_for(groups).to_a
    native_specs = resolved_specs.select { |spec| spec.extensions.any? }

    output = if $stdout.tty?
      rows = [["Name", "Version"]]
      output = Terminal::Table.new do |t|
        t << ["Name", "Version"]
        t << :separator
        native_specs.each do |spec|
          t << [spec.name, spec.version]
        end
      end
    else
      native_specs.map { |spec| "#{spec.name}\t#{spec.version}" }
    end

    $stdout.puts output
  end

  def definition
    Bundler.definition
  end
end

class CLI < Bundler::CLI
  desc "native_gems [OPTIONS]", "Lists the gems with native extensions"
  def native_gems
    NativeGems.new(options).run
  end
end

CLI.start(ARGV.dup.unshift("native_gems"), :debug => true)
